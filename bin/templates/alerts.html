{#
    Copyright (C) 2015  Ryan M Cote.

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License along
    with this program; if not, write to the Free Software Foundation, Inc.,
    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.

    Author: Ryan M Cote <minervaconsole@gmail.com>
#}

<!DOCTYPE html>
<html>
  <head>
  <link rel="icon" type="image/png" href="/images/favicon.ico">
  <script type="text/javascript" src="/jquery.min.js"></script>
  <script type="text/javascript" src="/js/bootstrap.js"></script>
  <script type="text/javascript" src="/js/DateTimePicker.min.js"></script>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="/css/DateTimePicker.min.css">
  <script src="/js/alerts.js"></script>
  <input type="hidden" id="form_type" value="{{form}}"></input>
  <input type="hidden" id="csrf_token" value="{{csrf_token}}"></input>
  </head>
	</script>
	<style>
	body {background-color:lightblue; padding-top:60px}
	</style>
	<title>Minerva Alert Search</title>
	<body>
	<nav class="navbar nav-pills navbar-default navbar-fixed-top">
	<div class="container">
	    <div class="navbar-header">
	    <a class="navbar-brand" href="/">Minerva</a>
	    </div>
	    <div id="navbar" class="navbar-collapse collapse">
            {% include 'menu.html' %}
            <ul class="nav navbar-nav navbar-right nav-pills">
            <li><a href="javascript:location='/alerts';" class="submenu_right">Reset</a></li>
            </ul>
	    </div>
	</div>
 	</div>
	</nav>
	<div style="width:100%;word-wrap:break-word;border:1px solid black;">
	<center><b>Search Alerts</b><br /></center>
        <table border="1" style="width:100%" id="SearchInput">
        <col width="12%">
        <col width="12%">
        <col width="12%">
        <col width="12%">
        <col width="12%">
        <col width="12%">
        <col width="12%">
        <col width="12%">
        <col width="4%">
        <tr><td align="center"><b>Start</b></td><td align="center"><b>Stop</b></td><td align="center"><b>Source IP</b></td><td align="center"><b>Source Port</b></td><td align="center"><b>Destination IP</b></td><td align="center"><b>Destination Port</b></td><td align="center"><b>Proto</b></td><td align="center"><b>Sensor</b></td><td align="center" rowspan="4"><a href="javascript:getFlows();">Submit</a></td></tr>
        <tr><td align="center"><input type=text id="start" data-field="datetime" {% if orig_search %}value="{{orig_search.start_epoch|epoch_to_datetime}}"{%endif%} readonly ><div id="datetime_start"></div></td>
        <td align="center"><input type=text id="stop" data-field="datetime" {% if orig_search %}value="{{orig_search['stop_epoch']|epoch_to_datetime}}"{% endif %} readonly ><div id="datetime_stop"></div></td>
        <td align="center"><input type=text id="src_ip" {% if orig_search %}{% if 'src_ip' in orig_search.keys() %}value="{{orig_search['src_ip']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="src_port" {% if orig_search %}{% if 'src_port' in orig_search.keys() %}value="{{orig_search['src_port']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="dest_ip" {% if orig_search %}{% if 'dest_ip' in orig_search.keys() %}value="{{orig_search['dest_ip']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="dest_port" {% if orig_search %}{% if 'dest_port' in orig_search.keys() %}value="{{orig_search['dest_port']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="proto" {% if orig_search %}{% if 'proto' in orig_search.keys() %}value="{{orig_search['proto']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="sensor" {% if orig_search %}{% if 'sensor' in orig_search.keys() %}value="{{orig_search['sensor']}}"{%endif%}{%endif%}></td></tr>
        <tr><td align="center"><b>Status</b></td><td align="center" colspan="2"><b>Signature Name</b></td><td align="center" ><b>Category</b></td><td align="center"><b>Severity</b></td><td align="center"><b>Signature ID</b></td><td align="center"><b>Revision</b></td><td align="center"><b>GID</b></td></tr>
        <tr><td align="center"><select id="status"><option value=''></option><option value="OPEN">Open</option><option value="ClOSED">Closed</option><option value="ESCALATED">Escalated</option></select></td>
        <td align="center" colspan="2"><input style="width:96%" type=text id="sig_name" {% if orig_search %}{% if 'sig_name' in orig_search.keys() %}value="{{orig_search['sig_name']}}"{%endif%}{%endif%}></td>
        <td align="center" ><input style="width:96%" type=text id="category" {% if orig_search %}{% if 'category' in orig_search.keys() %}value="{{orig_search['category']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="severity" {% if orig_search %}{% if 'severity' in orig_search.keys() %}value="{{orig_search['severity']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="sid" {% if orig_search %}{% if 'sid' in orig_search.keys() %}value="{{orig_search['sid']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="rev" {% if orig_search %}{% if 'rev' in orig_search.keys() %}value="{{orig_search['rev']}}"{%endif%}{%endif%}></td>
        <td align="center"><input type=text id="gid" {% if orig_search %}{% if 'gid' in orig_search.keys() %}value="{{orig_search['gid']}}"{%endif%}{%endif%}></td>
        </table>
        <script>
           $(document).ready(function()
           {
          
               $("#datetime_start").DateTimePicker({dateTimeFormat: "MM-dd-yyyy hh:mm:ss"});
               $("#datatime_stop").DateTimePicker({dateTimeFormat: "MM-dd-yyyy hh:mm:ss"});
          
           });
        </script>
	</div><br />
        <div id="HdrDiv" style="z-index:1000;background-color:lightblue;" width=100% >
        <table id="EventHdr" border="1" width=100% style="table-layout:fixed;" >
        <col width="2%">
        <col width="13%">
        <col width="8%">
        <col width="4%">
        <col width="9%">
        <col width="6%">
        <col width="9%">
        <col width="6%">
        <col width="14%">
        <col width="12%">
        <col width="4%">
        <col width="5%">
        <col width="4%">
        <col width="4%">
        <tr><th style="display:none;">ID</th><th></th><th style="word-wrap:break-word;" >Timestamp</th><th style="word-wrap:break-word;" >Sensor</th><th style="word-wrap:break-word;" >Proto</th><th style="word-wrap:break-word;" >Src IP</th><th style="word-wrap:break-word;" >Src Port</th><th style="word-wrap:break-word;" >Dest IP</th><th style="word-wrap:break-word;" >Dest Port</th><th style="word-wrap:break-word;" >Signature</th><th style="word-wrap:break-word;" >Category</th><th style="word-wrap:break-word;" >Sev</th><th>SID</th><th>Rev</th><th>GID</th></tr>
        </table>
        </div>
        <div id="TblDiv" style="width:100%;" >
        <table border="1" width=100% id="EventTable" style="table-layout:fixed;">
        <col width="2%">
        <col width="13%">
        <col width="8%">
        <col width="4%">
        <col width="9%">
        <col width="6%">
        <col width="9%">
        <col width="6%">
        <col width="14%">
        <col width="12%">
        <col width="4%">
        <col width="5%">
        <col width="4%">
        <col width="4%">
	{% if items_found == 'No Results Found' %}
	<b>No Results Found</b>
	</table><br />
	<strong>No Results Found</strong>
	{% else %}
        {% for item in items_found %}
        {% if item.document.alert.severity == 4 %}<tr bgcolor="red" onclick="startTrack(this)">{% elif item.document.alert.severity == 3 %}<tr bgcolor="orange" onclick="startTrack(this)">{% elif item.document.alert.severity == 2 %}<tr bgcolor="yellow" onclick="startTrack(this)"> {% elif item.document.alert.severity == 1 %}<tr bgcolor="green" onclick="startTrack(this)"> {% else %}<tr>{% endif %}<td align="center" style="display:none;">{{ item.ID }}</td><td align="center"><a href="javascript:getOneAlertFlow({{loop.index}});"><img src="/images/arrow.png" height="16" width="16" ></a></td><td align="center" style="word-wrap:break-word;" >{# item.document.time.isoformat #}{{ item.epoch|iso_to_utc}}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.sensor }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.proto }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.src_ip }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.src_port }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.dest_ip }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.dest_port }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.alert.signature }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.alert.category }}</td><td align="center">{{ item.document.alert.severity }}</td><td align="center" style="word-wrap:break-word;" >{{ item.document.alert.signature_id }}</td><td align="center">{{ item.document.alert.rev }}</td><td align="center">{{ item.document.alert.gid }}</td></tr>
        {% endfor %}
	</table>
	{% endif %}
	</div>
	</body>
</html>
